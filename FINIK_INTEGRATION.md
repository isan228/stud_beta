# Интеграция Finik Payments

## Описание

Полная интеграция системы оплаты Finik Payments для платформы stud.kg. Реализовано:
- ✅ Создание платежей через Finik Web SDK
- ✅ Генерация подписи для запросов
- ✅ Обработка webhook'ов с валидацией подписи
- ✅ Сохранение транзакций в базе данных
- ✅ Тестовая страница оплаты
- ✅ Страница успешной оплаты

## Установка

```bash
npm install
```

Установит необходимые зависимости:
- `@mancho.devs/authorizer` - **официальный пакет Finik** для генерации подписи
- `uuid` - для генерации уникальных PaymentId
- `node-fetch` - для HTTP запросов (если Node.js < 18)

**Важно:** Используется официальный пакет `@mancho.devs/authorizer` от команды Finik, как рекомендовано в документации. Это обеспечивает консистентность и правильность генерации подписи.

## Настройка

### 1. Переменные окружения

Добавьте в файл `.env`:

```env
# Finik Payments Configuration
FINIK_ENV=beta                    # beta или prod
FINIK_WEBHOOK_URL=https://your-domain.com/api/payments/webhook
FINIK_ACCOUNT_ID=your_account_id
FINIK_SERVICE_ID=your_service_id
```

### 2. Публичные ключи

Публичные ключи Finik уже встроены в `utils/finikValidator.js`:
- **Prod key** - для production окружения
- **Beta key** - для beta окружения (по умолчанию)

Ключ выбирается автоматически на основе переменной `FINIK_ENV`.

## Структура

### Модели

**Transaction** (`models/Transaction.js`)
- Хранит все транзакции от Finik
- Связь с пользователем (опционально)
- Сохраняет полный payload для отладки

### Роуты

**`/api/payments/webhook`** (POST)
- Обрабатывает callback от Finik
- Валидирует подпись запроса
- Сохраняет/обновляет транзакции в БД

**`/api/payments/transactions`** (GET)
- Получить список транзакций пользователя
- Требует авторизации

**`/api/payments/transactions/:id`** (GET)
- Получить конкретную транзакцию
- Требует авторизации

**`/api/payments/create`** (POST)
- Создать платеж через Finik API
- Генерирует QR код для оплаты
- Возвращает paymentUrl для редиректа
- Требует авторизации

### Утилиты

**`utils/finikValidator.js`**
- Валидация подписи запросов от Finik (webhook)
- Построение строки для валидации согласно документации
- Поддержка prod и beta окружений

**`utils/finikSigner.js`**
- ⚠️ Устаревший файл (не используется)
- Используется официальный пакет `@mancho.devs/authorizer` вместо собственной реализации

**`utils/finikClient.js`**
- Клиент для работы с Finik API
- Функция `createPayment()` для создания платежей
- Автоматическая генерация подписи
- Обработка ответов от Finik API

## Валидация подписи

Валидация выполняется автоматически при получении webhook'а. Алгоритм:

1. Собирается строка для валидации:
   - HTTP метод (lowercase)
   - URI путь
   - Заголовки (Host и x-api-*)
   - Query параметры
   - JSON body (отсортированный)

2. Подпись извлекается из заголовка `signature` или `x-signature`

3. Проверка с помощью RSA-SHA256 и публичного ключа Finik

## Webhook Payload

Пример payload от Finik:

```json
{
  "id": "transaction-id-15423_CREDIT",
  "accountId": "your account id",
  "amount": 100,
  "fields": {
    "amount": 100,
    "fieldId1": "value1",
    "fieldId2": "value2"
  },
  "item": {
    "id": "generated-item-id"
  },
  "net": 100,
  "receiptNumber": "some-number",
  "requestDate": 1737369012345,
  "service": {
    "id": "averspay-items"
  },
  "status": "SUCCEEDED",
  "transactionDate": 1737369012345,
  "transactionId": "transaction-id-241234",
  "transactionType": "DEBIT",
  "data": {
    "amount": 100,
    "fieldId1": "value1"
  }
}
```

## Тестовая страница

Доступна по адресу: `/payment`

Функционал:
- Ввод суммы платежа
- Описание платежа
- Выбор типа платежа
- Создание тестового платежа

**Важно:** В тестовом режиме платеж не отправляется в Finik, только создается запись в БД.

## Обработка успешных платежей

После получения webhook'а со статусом `SUCCEEDED`, можно добавить бизнес-логику в `routes/payments.js`:

```javascript
if (transaction.status === 'SUCCEEDED' && transaction.userId) {
  // Активировать подписку
  // Добавить баланс
  // Отправить уведомление
  // И т.д.
}
```

## Настройка в Finik

1. Зайдите в панель управления Finik
2. Укажите Webhook URL: `https://your-domain.com/api/payments/webhook`
3. Убедитесь, что URL доступен извне (не localhost)
4. Для тестирования можно использовать ngrok или аналогичный сервис

## Тестирование

### Локальное тестирование

1. Используйте ngrok для создания туннеля:
```bash
ngrok http 3000
```

2. Скопируйте HTTPS URL (например: `https://abc123.ngrok.io`)

3. Укажите в Finik webhook URL: `https://abc123.ngrok.io/api/payments/webhook`

4. Создайте тестовый платеж через Finik

5. Проверьте логи сервера на наличие webhook'а

### Проверка валидации

Если валидация не проходит:
1. Проверьте логи сервера - там будет строка для валидации
2. Убедитесь, что используется правильный публичный ключ (beta/prod)
3. Проверьте, что заголовок `signature` присутствует в запросе
4. Убедитесь, что body не был изменен middleware'ами

## Безопасность

- ✅ Валидация подписи всех webhook'ов
- ✅ Сохранение полного payload для аудита
- ✅ Логирование всех транзакций
- ✅ Авторизация для просмотра транзакций

## Дальнейшая интеграция

Для полной интеграции необходимо:

1. **Создание платежей через Finik API**
   - Интегрировать API Finik для создания платежей
   - Генерировать payment URL
   - Редиректить пользователя на страницу оплаты Finik

2. **Обработка успешных платежей**
   - Активация подписки
   - Начисление баланса
   - Отправка уведомлений

3. **Админ-панель**
   - Просмотр всех транзакций
   - Фильтрация и поиск
   - Статистика платежей

## Полезные ссылки

- Документация Finik: [ссылка на документацию]
- Тестовая страница: `/payment`
- Webhook endpoint: `/api/payments/webhook`

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь, что webhook URL доступен
3. Проверьте валидность подписи в логах
4. Убедитесь, что используется правильное окружение (beta/prod)

