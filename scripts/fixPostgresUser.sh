#!/bin/bash

# –ë—ã—Å—Ç—Ä—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º PostgreSQL
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/fixPostgresUser.sh

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å PostgreSQL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º..."

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ISAN): " DB_USER
DB_USER=${DB_USER:-ISAN}

read -sp "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $DB_USER: " NEW_PASSWORD
echo ""

# –í–∞—Ä–∏–∞–Ω—Ç 1: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å
echo "–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
sudo -u postgres psql -c "ALTER USER \"$DB_USER\" WITH PASSWORD '$NEW_PASSWORD';" 2>/dev/null && {
    echo "‚úì –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $DB_USER"
    exit 0
} || {
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞. –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ..."
}

# –í–∞—Ä–∏–∞–Ω—Ç 2: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
read -p "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: stud_user): " NEW_USER
    NEW_USER=${NEW_USER:-stud_user}
    
    sudo -u postgres psql -c "CREATE USER \"$NEW_USER\" WITH PASSWORD '$NEW_PASSWORD';" || {
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å..."
        sudo -u postgres psql -c "ALTER USER \"$NEW_USER\" WITH PASSWORD '$NEW_PASSWORD';"
    }
    
    # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE stud_kg TO \"$NEW_USER\";" 2>/dev/null || {
        echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö stud_kg –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞–µ–º..."
        sudo -u postgres psql -c "CREATE DATABASE stud_kg OWNER \"$NEW_USER\";"
    }
    
    DB_USER=$NEW_USER
    echo "‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $NEW_USER —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω"
fi

# –û–±–Ω–æ–≤–ª—è–µ–º .env
if [ -f .env ]; then
    sed -i "s/^DB_USER=.*/DB_USER=$DB_USER/" .env
    sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=$NEW_PASSWORD/" .env
    echo "‚úì .env —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é."
fi

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞: npm run init-db"

